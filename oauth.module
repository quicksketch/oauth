<?php
// $Id$
/**
 * @author OAuth module Dev Team
 * @file
 *  OAuth module's main file.
 *
 *  Only hooks and fundamental functions are placed here.
 */

/**
 * Implementation of hook_menu().
 */
function oauth_menu() {
  $items['webservice/token_auth'] = array(
    'access callback'   => TRUE,
    'file'              => 'oauth.inc',
    'page callback'     => '_oauth_token_auth',
    'type'              => MENU_CALLBACK,
  );
  $items['webservice/token_request'] = array(
    'access callback'   => TRUE,
    'file'              => 'oauth.inc',
    'page callback'     => '_oauth_token_request',
    'type'              => MENU_CALLBACK,
  );
  $items['webservice/token_access'] = array(
    'access callback'   => TRUE,
    'file'              => 'oauth.inc',
    'page callback'     => '_oauth_token_access',
    'type'              => MENU_CALLBACK,
  );

  return $items;
}

/**
 * Implementation of hook_perm().
 */
function oauth_perm() {
  return array('view own access token');
}

/**
 * Implementation of hook_webservices_info().
 *
 * It integrates to Web Services module, letting the consumers to get
 * tokens thru Web Services.
 */
function oauth_webservices_info() {
  return array(
    array(
      '#method'           => 'system.tokenRequest',
      '#description'      => t('Request a OAuth request token.'),
      '#callback'         => '_oauth_token_request',
      '#no_auth'          => TRUE,
      '#file'             => array('file' => 'inc', 'module' => 'oauth'),
      '#args'             => array(
        array(
          '#name'           => 'timestamp',
          '#type'           => 'int',
          '#description'    => t('The timestamp of the request.'),
        ),
        array(
          '#name'           => 'nonce',
          '#type'           => 'string',
          '#description'    => t('The random 32 characters long string used on each request.'),
        ),
        array(
          '#name'           => 'consumer_key',
          '#type'           => 'string',
          '#description'    => t('Consumer key.'),
        ),
        array(
          '#name'           => 'consumer_secret',
          '#type'           => 'string',
          '#description'    => t('Consumer secret.'),
        ),
      ),
      '#return'           => 'array',
    ),
    array(
      '#method'           => 'system.tokenAccess',
      '#description'      => t('Request a OAuth access token.'),
      '#callback'         => '_oauth_token_access',
      '#no_auth'          => TRUE,
      '#file'             => array('file' => 'inc', 'module' => 'oauth'),
      '#args'             => array(
        array(
          '#name'           => 'timestamp',
          '#type'           => 'int',
          '#description'    => t('The timestamp of the request.'),
        ),
        array(
          '#name'           => 'nonce',
          '#type'           => 'string',
          '#description'    => t('The random 32 characters long string used on each request.'),
        ),
        array(
          '#name'           => 'consumer_key',
          '#type'           => 'string',
          '#description'    => t('Consumer key.'),
        ),
        array(
          '#name'           => 'token_key',
          '#type'           => 'string',
          '#description'    => t('OAuth Resquest token.'),
        ),
      ),
      '#return'           => 'array',
    ),
  );
}

/**
 * Implementation of hook_webservices_auth_info().
 *
 * It integrates to Web Services module, adding the OAuth as a
 * authentication plugin.
 */
function oauth_webservices_auth_info() {
  return array(
    '#name'   => t('OAuth'),
    '#file'   => array('file' => 'inc', 'module' => 'oauth'),
    '#class'  => '_oauth_auth',
  );
}

/**
 * Implementation of hook_user().
 */
function oauth_user($op, &$edit, &$account, $category = NULL) {
  global $user;

  // If the user that has the permission to use Web Services is seeing
  // his own profile, show his OAuth consumer key and secret.
  if ($op == 'view' and user_access('integrate external application', $account) and
      ($account->uid == $user->uid or user_access('administer webservices'))) {
    module_load_include('inc', 'oauth');
    $consumer = _oauth_consumer_get($account->uid);
    $account->content['oauth'] = array(
      '#attributes' => array('class' => 'user-member'),
      '#title'      => t('Web services'),
      '#type'       => 'user_profile_category',
      '#weight'     => 5,
    );
    $account->content['oauth']['consumer_key'] = array(
      '#title'      => t('Consumer key'),
      '#type'       => 'user_profile_item',
      '#value'      => $consumer->key,
    );
    $account->content['oauth']['consumer_secret'] = array(
      '#title'      => t('Consumer secret'),
      '#type'       => 'user_profile_item',
      '#value'      => $consumer->secret,
    );

    // Specially useful for developers, it will create and show
    // a Access Token for the own user. Remember that all services
    // are authorized when consumer and the user are the same.
    if (user_access('view own access token', $account)) {
      if (!$token = db_fetch_object(db_query("SELECT token_key, token_secret AS secret
          FROM {oauth_token}
          WHERE uid = %d AND consumer_key = '%s' AND type = 'access'",
          $account->uid, $consumer->key))) {
        $token = new OAuthToken(user_password(32), user_password(32));
        $sql = array(
          'consumer_key'    => $consumer->key,
          'type'            => 'access',
          'token_key'       => $token->key,
          'token_secret'    => $token->secret,
          'uid'             => $account->uid,
          'webservices'     => serialize(array())
        );
        drupal_write_record('oauth_token', $sql);
      }
      $account->content['oauth']['own_access_token_key'] = array(
        '#title'      => t('Access token key'),
        '#type'       => 'user_profile_item',
        '#value'      => empty($token->key) ? $token->token_key : $token->key,
      );
      $account->content['oauth']['own_access_token_secret'] = array(
        '#title'      => t('Access token secret'),
        '#type'       => 'user_profile_item',
        '#value'      => empty($token->secret) ? $token->token_secret : $token->secret,
      );
    }
  }

  // Delete all tokens related to a user
  elseif ($op == 'delete') {
    $consumer = _oauth_consumer_get($account->uid);
    db_query('DELETE FROM {oauth_consumer}
      WHERE uid = %d', $account->uid);
    db_query("DELETE FROM {oauth_token}
      WHERE uid = %d OR consumer_key = '%s'", $account->uid, $consumer->key);
  }
}
